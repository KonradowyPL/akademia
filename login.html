<span id="message"></span>
<div id="container"></div>
<script>
  function addMessage(val) {
    const ele = document.createElement("span");
    ele.innerHTML = val + "<br>";
    message.appendChild(ele);
  }

  function getToken() {
    var token = urlParams.get("userId");
    if ((token || "").length == 0) {
      token = prompt("Input your token here. If you do not have it ask owner to make one for you.");
    }

    if ((token || "").length != 32) {
      addMessage("Entered wrong token is in wrong format!");
      return null;
    }
    return token;
  }

  function login() {
    const token = getToken();

    if (token != null) {
      var isOk = true;

      addMessage("Sending data");

      fetch(`https://konradowy.pythonanywhere.com?userId=${token}`)
        .then((response) => {
          text = response.json();
          if (!response.ok) {
            isOk = false;
          }
          return text;
        })

        .then((data) => {
          if (!isOk) {
            addMessage(data.message);
          } else {
            const version = data.version;
            const url = data.url;
            const userName = data.userName;

            addMessage("Loging in...");
            const script = document.createElement("script");
            script.src = url;
            document.getElementById("container").appendChild(script);

            let checkExist = setInterval(function () {
              if (typeof tests !== "undefined") {
                localStorage.clear();
                localStorage.setItem("tests", JSON.stringify(tests));
                localStorage.setItem("file", url);
                localStorage.setItem("version", version);
                localStorage.setItem("userId", token);
                localStorage.setItem("userName", userName);

                addMessage("Logged in succesfully!");
                addMessage("Redirecting...");

                window.location.href = "./search.html";

                clearInterval(checkExist);
              }
            }, 100);
          }
        })
        .catch((error) => {
          message.innerHTML = `Error: ${error}`;
          console.error("Error:", error);
        });
    }
  }

  function doAction(action) {
    if (action == "logout") {
      localStorage.clear();
      addMessage("Logged Out succesfully!");
    } else if (action == "relog") {
      addMessage("relogging...");
      document.location.href = `./login.html?action=login&userId=${localStorage.getItem("userId")}`;
    } else if (action == "login") {
      login();
    } else {
      addMessage("Non-existent action provided!");
    }
  }
  const message = document.getElementById("message");
  const urlParams = new URLSearchParams(window.location.search);
  const action = urlParams.get("action");

  doAction(action);
</script>
